<html>

  <!--State: home-->
  <div id="home_state" style="display:block">
    <button id="new_walkthrough">New walkthrough</button>
    <p><b>Walkthroughs</b></p>
    <div id="walkthrough_list">Loading walkthroughs...</div>
  </div>

  <!--State: editing-->
  <div id="editing_state" style="display:none">
    <button id="add_nodes">Add selected</button><button id="exit_new">Cancel</button>
    <hr>
    <div id="nodes_list">Select an element or two and click Add selected</div>
    <input id="walkthrough_name"></input><button id="save_walkthrough">Save walkthrough</button>
  </div>

  <!--State: walking-->
  <div id="walking_state" style="display:none">
    <p id="selected_node">Click next to start</p>
    <button id="next">Next</button>
    <button id="exit_walking">Exit</button>
    <hr>
    <p id="note"></p>
  </div>

  <!--State: noting-->
  <div id="noting_state">
    <textarea id="noting" rows="3" cols="30" maxlength="50" wrap="soft"></textarea>
    <br />
    <button id="save_note">Save note</button>
  </div>

  <script>
  onmessage = (event) => {
    const message = event.data.pluginMessage;
    switch (message.type) {
      case 'state':
        const state = message.state;
        document.getElementById('home_state').style.display = (state == 'home') ? ("block") : ("none");
        document.getElementById('walking_state').style.display = (state == 'walking') ? ("block") : ("none");
        document.getElementById('editing_state').style.display = (state == 'editing' | state == 'new') ? ("block") : ("none");
        break;
      case 'walkthrough_list':
        const walkthroughs = message.walkthroughs;
        let walkthroughListContents = 'Create a walkthrough to get started.';
        if (walkthroughs.length > 0) {
          walkthroughListContents = '<ul>';
          walkthroughs.forEach(walkthrough => {
            const name = walkthrough.name;
            const id = walkthrough.id;
            walkthroughListContents += '<li>' + name;
            walkthroughListContents += getButtonString(id, 'start');
            walkthroughListContents += getButtonString(id, 'edit');
            walkthroughListContents += getButtonString(id, 'delete');
            walkthroughListContents += '</li>';
          });
          walkthroughListContents += '</ul>';
        }
        document.getElementById("walkthrough_list").innerHTML = walkthroughListContents;
        if (walkthroughs.length > 0) {
          walkthroughs.forEach(walkthrough => {
            const id = walkthrough.id;
            addWalkthroughListener('start', id + '_wts');
            addWalkthroughListener('edit', id + '_wte');
            addWalkthroughListener('delete', id + '_wtd');
          });
        }
        break;
      case 'editing_update':
        const name = message.walkthrough.name;
        const nodes = message.walkthrough.nodes;
        document.getElementById('walkthrough_name').value = name;
        let nodeListContents = 'Select and add some elements to the walkthrough.';
        if (nodes.length > 0) {
          nodeListContents = '<ul>';
            nodes.forEach(node => {
              const name = node.name;
              const id = node.id;
              nodeListContents += '<li>' + name;
              nodeListContents +=  ' ' + getButtonString(id, 'up');
              nodeListContents +=  ' ' + getButtonString(id, 'down');
              nodeListContents +=  ' ' + getButtonString(id, 'remove');
              nodeListContents += '</li>';
          });
          nodeListContents += '</ul>';
        }
        document.getElementById("nodes_list").innerHTML = nodeListContents;
        if (nodes.length > 0) {
          nodes.forEach(node => {
            const id = node.id;
            addWalkthroughListener('up', id + '_nup');
            addWalkthroughListener('down', id + '_ndn');
            addWalkthroughListener('remove', id + '_nrm');
          });
        }
        break;
      case 'editing_clear':
        document.getElementById('walkthrough_name').value = null;
        document.getElementById("nodes_list").innerHTML = null;
        break;
      case 'note':
        document.getElementById('selected_node').innerHTML = message.name;
        document.getElementById('note').innerHTML = message.note;
        break;
      default:
        console.error('no ui message handler');
        return;
    }
  }
  // creating walkthrough
  document.getElementById('new_walkthrough').onclick = () => {
    parent.postMessage({ pluginMessage: { type: 'state_new'} }, '*');
  }
  document.getElementById('add_nodes').onclick = () => {
    parent.postMessage({ pluginMessage: { type: 'add_nodes' }}, '*');
  }
  document.getElementById('save_walkthrough').onclick = () => {
    const name = document.getElementById('walkthrough_name').value;
    parent.postMessage({ pluginMessage: { type: 'save_walkthrough', value: name }}, '*');
  }
  document.getElementById('exit_new').onclick = () => {
    parent.postMessage({ pluginMessage: { type: 'state_home'}}, '*');
  }
  // walking through
  document.getElementById('next').onclick = () => {
    parent.postMessage({ pluginMessage: { type: 'next' } }, '*');
  }
  document.getElementById('save_note').onclick = () => {
    let note = document.getElementById('note').value;
    parent.postMessage({ pluginMessage: { type: 'save_note', value: note } }, '*');
  }
  document.getElementById('exit_walking').onclick = () => {
    parent.postMessage({ pluginMessage: { type: 'state_home'}}, '*');
  }
  // helper functions
  function getButtonString(id, type) {
    let label = null;
    let buttonId = null;
    switch(type) {
      case 'start':
        label = 'Start';
        buttonId = id + '_wts';
        break;
      case 'edit':
        label = 'Edit';
        buttonId = id + '_wte';
        break;
      case 'delete':
        label = 'Delete';
        buttonId = id + '_wtd';
        break;
      case 'up':
        label = '↑';
        buttonId = id + '_nup';
        break;
      case 'down':
        label = '↓';
        buttonId = id + '_ndn';
        break;
      case 'remove':
        label = '⊗';
        buttonId = id + '_nrm';
        break;
      default:
        console.error('no button type');
    }
    return '<button id="' + buttonId + '">' + label + '</button>';
  }
  function addWalkthroughListener(type, id) {
    document.getElementById(id).onclick = () => {
      parent.postMessage({ pluginMessage: { type: type, value: id } }, '*');
    }
  }
  </script>
</html>