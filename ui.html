<style>
    html, body {
      font-family: Arial, Helvetica, sans-serif;
      padding: 0;
      margin: 0;
      background-color: #e5e5e5;
      font-size: 11pt;
      overflow: hidden;
      height: 100%;
    }
    div {
      padding: 0;
      margin: 0;
    }
    input {
      font-family: inherit;
      outline: none;
      border: none;
      padding: .3rem .5rem;
      border-radius: .3rem;
      background-color: lightgray;
      margin: 0;
      font-size: 1rem;
    }
    button:hover {
      color: black;
    }
    button {
      background: none;
      border: none;
      outline: none;
      margin: 0;
      padding: .4rem .6rem;
      border-radius: .3rem;
      color: darkblue;
      font-family: inherit;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      vertical-align: middle;
    }
    button.text {
      color: darkslategrey;

    }
    button.text:hover {
      color: black;
    }
    button.red {
      width: 100%;
      background-color: #dddddd;
      color: darkred;
    }
    button.red:hover {
      background-color: silver;
      color: black;
    }
    button.action {
      background-color: white;
    }
    button.action:hover {
      background: darkblue;
      color: white;
    }
    button.icon {
      margin: 0 .5rem 0 0;
      padding: .2rem;
      font-size: 1.3rem;
      background: none;
      color: dimgrey;
    }
    button.icon:hover {
      color: black;
    }
    button.icon-delete {
      margin: 0;
      padding: .2rem 0 .2rem;
      font-size: 1.6rem;
      background: none;
      color: dimgrey;
    }
    button.icon-delete:hover {
      color: red;
    }
    table {
      padding: 0;
      margin: 0;
      border: none;
      width: 100%;
    }
    tr {
      margin: 0 0 .5rem 0;
    }
    .list {
      padding: .5rem 1rem;
      height: calc(100% - 105px);
      overflow: auto;
      scroll-behavior: smooth;
    }
    .placeholder {
        color: #a9a9a9;
        font-weight: bold;
        text-align: center;
        padding: 2rem 1rem;
    }
    .toolbar {
      background-color: #dddddd;
      padding: .3rem .4rem .4rem;
      height: 40px;
    }
    .table-right {
      text-align: right;
    }
    .footer {
      background-color: #dddddd;
      position: fixed;
      height: 40px;
      bottom: 0;
      left: 0;
      right: 0;
    }
    .footer * {
      width: 100%;
    }
</style>
<html>
  <!--State: home-->
  <div id="home_state" style="display:block">
    <table class="toolbar">
      <tr>
        <td>
          <button id="new_walkthrough">Create</button>
        </td>
        <td class="table-right">
          <button id="login" class="text">Login</button>
        </td>
      </tr>
    </table>
    <div id="walkthrough_list" class="list">
      <p class="placeholder">Loading...</p>
    </div>
  </div>

  <!--State: editing-->
  <div id="editing_state" style="display:none">
    <table class="toolbar">
      <tr>
        <td>
          <button id="add_nodes" class="action">Add selected</button>
        </td>
        <td class="table-right">
          <button id="exit_new" class="text">Cancel</button>
        </td>
      </tr>
    </table>
    <div id="nodes_list" class="list">
      <p class="placeholder">Add some elements</p>
    </div>
    <table class="footer">
      <tr>
        <td>
          <input id="walkthrough_name"></input>
        </td>
        <td class="table-right">
          <button id="save_walkthrough">Save</button>
        </td>
      </tr>
    </table>
  </div>

  <!--State: walking-->
  <div id="walking_state" style="display:none">
    <div class="toolbar">
      <button id="next">➜</button>
      <button id="edit_note">✎</button>
      <button id="exit_walking">✕</button>
    </div>
    <p id="selected_node" class="layer-title"></p>
    <p id="note" class="note"></p>
  </div>

  <!--State: noting-->
  <div id="noting_state">
    <p id="editing_node"></p>
    <button id="save_note">Save</button>
    <textarea id="noting" rows="3" cols="30" maxlength="50" wrap="soft"></textarea>
  </div>

  <script>
  onmessage = (event) => {
    const message = event.data.pluginMessage;
    switch (message.type) {
      case 'state':
        const state = message.state;
        document.getElementById('home_state').style.display = (state == 'home') ? ("block") : ("none");
        document.getElementById('walking_state').style.display = (state == 'walking') ? ("block") : ("none");
        document.getElementById('editing_state').style.display = (state == 'editing' | state == 'new') ? ("block") : ("none");
        document.getElementById('noting_state').style.display = (state == 'note') ? ("block") : ("none");
        break;
      case 'walkthrough_list':
        const walkthroughs = message.walkthroughs;
        let walkthroughListContents = '<p class="placeholder">Create a walkthrough to get started</p>';
        if (walkthroughs.length > 0) {
          walkthroughListContents = '<table>';
          walkthroughs.forEach(walkthrough => {
            const name = walkthrough.name;
            const id = walkthrough.id;
            walkthroughListContents += '<tr><td>' + name + '</td>';
            walkthroughListContents += '<td class="table-right">';
            walkthroughListContents += getButton(id, 'edit');
            walkthroughListContents += getButton(id, 'start');
            walkthroughListContents += '</td></tr>';
          });
          walkthroughListContents += '</table>';
        }
        document.getElementById("walkthrough_list").innerHTML = walkthroughListContents;
        if (walkthroughs.length > 0) {
          walkthroughs.forEach(walkthrough => {
            const id = walkthrough.id;
            addWalkthroughListener('start', id + '_wts');
            addWalkthroughListener('edit', id + '_wte');
          });
        }
        break;
      case 'editing_update':
        const newOrEditing = message.walkthrough.state;
        const name = message.walkthrough.name;
        const walkthroughID = message.walkthrough.id;
        const nodes = message.walkthrough.nodes;
        document.getElementById('walkthrough_name').value = name;
        let nodeListContents = '<p class="placeholder">Select and add some elements to the walkthrough.</p>';
        if (nodes.length > 0) {
          nodeListContents = '<table>';
            nodes.forEach(node => {
              const name = node.name;
              const id = node.id;
              nodeListContents += '<tr><td>' + name + '</td>';
              nodeListContents += '<td class="table-right">';
              nodeListContents +=  getButton(id, 'note');
              nodeListContents +=  getButton(id, 'up');
              nodeListContents +=  getButton(id, 'down');
              nodeListContents +=  getButton(id, 'remove');
              nodeListContents += '</td></tr>';
          });
          nodeListContents += '</table>';
          if (newOrEditing == 'editing') {
            nodeListContents += getButton(walkthroughID, 'delete')
          }
        }
        document.getElementById("nodes_list").innerHTML = nodeListContents;
        document.getElementById("nodes_list").scrollTop = 0;
        if (nodes.length > 0) {
          nodes.forEach(node => {
            const id = node.id;
            addWalkthroughListener('note', id + '_nno');
            addWalkthroughListener('up', id + '_nup');
            addWalkthroughListener('down', id + '_ndn');
            addWalkthroughListener('remove', id + '_nrm');
          });
        }
        if (newOrEditing == 'editing') {
          addWalkthroughListener('delete', walkthroughID + '_wtd');
        }
        break;
      case 'editing_clear':
        document.getElementById('walkthrough_name').value = null;
        document.getElementById("nodes_list").innerHTML = null;
        break;
      case 'note':
        document.getElementById('selected_node').innerHTML = message.name;
        document.getElementById('note').innerHTML = message.note;
        document.getElementById('edit_note').onclick = () => {
          parent.postMessage({pluginMessage: {
            type: 'note',
            value: message.id + '_nno'
          }},'*');
        }
        break;
      case 'noting':
        document.getElementById('editing_node').innerHTML = message.name;
        document.getElementById('noting').value = message.note;
        break;
      default:
        console.error('no ui message handler');
        return;
    }
  }
  // creating walkthrough
  document.getElementById('new_walkthrough').onclick = () => {
    parent.postMessage({ pluginMessage: { type: 'state_new'} }, '*');
  }
  document.getElementById('add_nodes').onclick = () => {
    parent.postMessage({ pluginMessage: { type: 'add_nodes' }}, '*');
  }
  document.getElementById('save_walkthrough').onclick = () => {
    const name = document.getElementById('walkthrough_name').value;
    parent.postMessage({ pluginMessage: { type: 'save_walkthrough', value: name }}, '*');
  }
  document.getElementById('exit_new').onclick = () => {
    parent.postMessage({ pluginMessage: { type: 'state_home'}}, '*');
  }
  // walking through
  document.getElementById('next').onclick = () => {
    parent.postMessage({ pluginMessage: { type: 'next' } }, '*');
  }
  document.getElementById('save_note').onclick = () => {
    let note = document.getElementById('noting').value;
    parent.postMessage({ pluginMessage: { type: 'save_note', value: note } }, '*');
  }
  document.getElementById('exit_walking').onclick = () => {
    parent.postMessage({ pluginMessage: { type: 'state_home'}}, '*');
  }
  // helper functions
  function getButton(id, type) {
    let label = null;
    let buttonId = null;
    let styles = null;
    switch(type) {
      case 'start':
        label = 'Start';
        buttonId = id + '_wts';
        styles = 'action';
        break;
      case 'edit':
        label = '✎';
        buttonId = id + '_wte';
        styles = 'icon';
        break;
      case 'delete':
        label = 'Delete Walkthrough';
        buttonId = id + '_wtd';
        styles = 'red';
        break;
      case 'note':
        label = '✎';
        buttonId = id + '_nno';
        styles = 'icon';
        break;
      case 'up':
        label = '↑';
        buttonId = id + '_nup';
        styles = 'icon';
        break;
      case 'down':
        label = '↓';
        buttonId = id + '_ndn';
        styles = 'icon';
        break;
      case 'remove':
        label = '✕';
        buttonId = id + '_nrm';
        styles = 'icon-delete';
        break;
      default:
        console.error('no button type');
    }
    return '<button id="' + buttonId + '" class="' + styles + '">' + label + '</button>';
  }
  function addWalkthroughListener(type, id) {
    document.getElementById(id).onclick = () => {
      parent.postMessage({ pluginMessage: { type: type, value: id } }, '*');
    }
  }
  </script>
</html>